<!DOCTYPE html>
<html>
<head>
  <title>CRT Screener</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }

    th {
      background: #222;
      color: #fff;
      padding: 8px;
    }

    td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }

    tr:hover {
      background: #f0f8ff;
    }

    button {
      padding: 6px 10px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<h2>CRT Screener</h2>

<select id="tf">
  <option value="daily">Daily</option>
  <option value="weekly">Weekly</option>
  <option value="monthly">Monthly</option>
</select>

<button onclick="runScan()">Run Scan</button>

<h3>Results</h3>

<table>
  <thead>
    <tr>
      <th>Symbol</th>
      <th>Timeframe</th>
      <th>Status</th>
      <th>Chart</th>
    </tr>
  </thead>
  <tbody id="result"></tbody>
</table>

<h3>Chart</h3>
<div id="tvChart"></div>

<!-- TradingView Library -->
<script src="https://s3.tradingview.com/tv.js"></script>

<script>
let tvWidget;

function loadChart(symbol, interval) {
  if (tvWidget) tvWidget.remove();

  tvWidget = new TradingView.widget({
    width: "100%",
    height: 500,
    symbol: symbol,
    interval: interval,
    timezone: "Asia/Kolkata",
    theme: "light",
    style: "1",
    locale: "en",
    container_id: "tvChart"
  });
}

function runScan() {
  const tf = document.getElementById("tf").value;

  const intervalMap = {
    daily: "D",
    weekly: "W",
    monthly: "M"
  };

  const symbols = [
    { name: "XAUUSD", tv: "OANDA:XAUUSD" },
    { name: "XAGUSD", tv: "OANDA:XAGUSD" },
    { name: "US500", tv: "OANDA:SPX500USD" }
  ];

  const tbody = document.getElementById("result");
  tbody.innerHTML = "";

  symbols.forEach(symbol => {
    fetch("https://crt-screener-backend-rnoo.vercel.app/scan?tf=" + tf)
      .then(res => res.json())
      .then(data => {
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${symbol.name}</td>
          <td>${data.timeframe}</td>
          <td>${data.status}</td>
          <td>
            <button onclick="loadChart('${symbol.tv}', '${intervalMap[tf]}')">
              ðŸ“ˆ View
            </button>
          </td>
        `;

        tbody.appendChild(row);
      })
      .catch(() => {
        tbody.innerHTML += `
          <tr>
            <td>${symbol.name}</td>
            <td>${tf}</td>
            <td>Error</td>
            <td>-</td>
          </tr>
        `;
      });
  });
}
</script>

</body>
</html>
